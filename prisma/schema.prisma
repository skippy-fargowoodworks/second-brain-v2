generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum SkippyStatus {
  working
  idle
}

enum TaskStatus {
  backlog
  in_progress
  review
  done
}

enum TaskPriority {
  critical
  high
  medium
  low
}

model Status {
  id        String       @id @default(cuid())
  status    SkippyStatus @default(idle)
  updatedAt DateTime     @updatedAt

  @@map("status")
}

model Task {
  id          String       @id @default(cuid())
  title       String
  description String?
  status      TaskStatus   @default(backlog)
  priority    TaskPriority @default(medium)
  tags        String       @default("") // comma-separated
  proofWhatChanged String?   @map("proof_what_changed")
  proofWhatItDoes  String?   @map("proof_what_it_does")
  proofHowToUse    String?   @map("proof_how_to_use")
  proofTests       String?   @map("proof_tests")
  proofScreenshot  String?   @map("proof_screenshot") // URL to screenshot proving the feature works
  dueDate     DateTime?    @map("due_date")
  projectId   String?      // Optional link to project
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  activities  TaskActivity[]
  subtasks    Subtask[]
  project     Project?     @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([priority])
  @@index([projectId])
  @@index([dueDate])
  @@map("tasks")
}

model Subtask {
  id        String   @id @default(cuid())
  taskId    String
  title     String
  done      Boolean  @default(false)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId, sortOrder])
  @@map("subtasks")
}

model TaskActivity {
  id        String   @id @default(cuid())
  taskId    String
  message   String
  createdAt DateTime @default(now())

  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId, createdAt])
  @@map("task_activities")
}

model Note {
  id        String   @id @default(cuid())
  title     String
  content   String
  category  String   @default("General")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@map("notes")
}

model Credential {
  id        String   @id @default(cuid())
  service   String
  username  String
  password  String
  url       String?  
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([service])
  @@map("credentials")
}

model Conversation {
  id           String   @id @default(cuid())
  date         DateTime @default(now())
  participants String   @default("")
  summary      String
  keyPoints    String   @default("") // newline-separated
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([date])
  @@map("conversations")
}

model WorkingMessage {
  id        String   @id @default(cuid())
  author    String   // "Jake" | "Skippy"
  message   String
  createdAt DateTime @default(now())

  @@index([createdAt])
  @@map("working_messages")
}

model Activity {
  id        String   @id @default(cuid())
  entity    String   // task|note|conversation|vault|status|working
  entityId  String?
  message   String
  createdAt DateTime @default(now())

  @@index([createdAt])
  @@map("activity")
}

model Usage {
  id           String   @id @default(cuid())
  date         DateTime @default(now())
  task         String?  // short description of what the call was for
  model        String   // e.g., "claude-opus-4-5", "gpt-4.1"
  provider     String   // e.g., "anthropic", "openai"
  tokensIn     Int      @default(0)
  tokensOut    Int      @default(0)
  cost         Float    @default(0) // in dollars
  sessionKey   String?  // optional session identifier
  createdAt    DateTime @default(now())

  @@index([date])
  @@index([model])
  @@map("usage")
}

// ============ NEW FEATURES ============

// Feature 1: Decision Queue
enum DecisionStatus {
  pending
  resolved
  deferred
}

model Decision {
  id          String         @id @default(cuid())
  title       String
  description String?
  context     String?        // Background info for the decision
  options     String?        // JSON array of options
  priority    TaskPriority   @default(medium)
  status      DecisionStatus @default(pending)
  dueDate     DateTime?
  resolution  String?        // What was decided
  resolvedAt  DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@index([status])
  @@index([priority])
  @@map("decisions")
}

// Feature 4: Family Dashboard
enum FamilyEventType {
  birthday
  anniversary
  event
}

model FamilyEvent {
  id        String          @id @default(cuid())
  name      String          // e.g., "Melissa's Birthday"
  person    String?         // Person's name if applicable
  type      FamilyEventType
  date      DateTime        // The date (year may be ignored for recurring)
  month     Int             // 1-12 for easy querying
  day       Int             // 1-31 for easy querying
  recurring Boolean         @default(true)
  notes     String?
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  @@index([month, day])
  @@map("family_events")
}

// Feature 6: Goals/OKR Tracking
enum GoalStatus {
  active
  completed
  abandoned
}

model Goal {
  id          String     @id @default(cuid())
  title       String
  description String?
  targetDate  DateTime?
  status      GoalStatus @default(active)
  progress    Int        @default(0) // 0-100
  category    String     @default("Business")
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  keyResults  KeyResult[]

  @@index([status])
  @@map("goals")
}

model KeyResult {
  id        String   @id @default(cuid())
  goalId    String
  title     String
  target    Float    // Target value
  current   Float    @default(0) // Current value
  unit      String   @default("") // e.g., "%", "$", "count"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  goal      Goal     @relation(fields: [goalId], references: [id], onDelete: Cascade)

  @@index([goalId])
  @@map("key_results")
}

// Feature 7: Recurring Tasks
enum RecurringSchedule {
  daily
  weekly
  monthly
}

model RecurringTask {
  id            String            @id @default(cuid())
  title         String
  description   String?
  priority      TaskPriority      @default(medium)
  schedule      RecurringSchedule
  dayOfWeek     Int?              // 0-6 for weekly (0=Sunday)
  dayOfMonth    Int?              // 1-31 for monthly
  lastGenerated DateTime?
  active        Boolean           @default(true)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@index([active])
  @@map("recurring_tasks")
}

// Feature 8: Habit Tracker
enum HabitFrequency {
  daily
  weekly
}

model Habit {
  id            String         @id @default(cuid())
  name          String
  description   String?
  frequency     HabitFrequency @default(daily)
  streak        Int            @default(0)
  longestStreak Int            @default(0)
  active        Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  logs          HabitLog[]

  @@map("habits")
}

model HabitLog {
  id        String   @id @default(cuid())
  habitId   String
  date      DateTime
  completed Boolean  @default(true)
  notes     String?
  createdAt DateTime @default(now())

  habit     Habit    @relation(fields: [habitId], references: [id], onDelete: Cascade)

  @@unique([habitId, date])
  @@index([habitId, date])
  @@map("habit_logs")
}

// Feature 9: Gratitude/Wins Log
enum WinCategory {
  personal
  business
  family
  health
}

model Win {
  id        String      @id @default(cuid())
  content   String
  category  WinCategory @default(personal)
  date      DateTime    @default(now())
  createdAt DateTime    @default(now())

  @@index([date])
  @@index([category])
  @@map("wins")
}

// Feature 10: Project Portfolio
enum ProjectStatus {
  active
  completed
  on_hold
}

model Project {
  id          String        @id @default(cuid())
  name        String
  description String?
  status      ProjectStatus @default(active)
  priority    TaskPriority  @default(medium)
  startDate   DateTime      @default(now())
  targetDate  DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  tasks       Task[]

  @@index([status])
  @@map("projects")
}
